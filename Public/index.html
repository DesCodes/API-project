<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" href="style.css">
	<link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel="stylesheet">

	<script src='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v2.7.0/mapbox-gl.css' rel='stylesheet' />
	<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.min.js'></script>
	<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.7.0/mapbox-gl-geocoder.css' type='text/css' />
	
	<title>Restaurant Locator</title>
</head>
<body>
	<div class="formBox">
		<h1 class="title">Restaurant Locator</h1>
		<form id="userInput" action="" class="wrapper userInput">
			<!-- <input type="text" placeholder="Input location">
			<input type="submit"> -->
			<button id="userLocation">Search nearby</button>
		</form>
		<div id='map'></div>
	</div>

	
	
	<footer>
		<p>Made with Yelp API and Mapbox</p>
	</footer>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="db.js"></script>
	<script>
		mapApp = {};

		mapboxgl.accessToken = 'pk.eyJ1IjoicmhvZ2EiLCJhIjoiY2pva3oyamNxMDNpdDNwcDM2NjRyejJkNSJ9.TYs4auLcIzhsSxVgI7EXlw';
		mapApp.map = new mapboxgl.Map({
				container: 'map', // container ID
				style: 'mapbox://styles/mapbox/streets-v11', // style URL
				center: [-79.37, 43.84], // starting position [lng, lat]
				zoom: 13 // starting zoom
		});


		mapApp.map.on('load', () => {
			const geocoder = new MapboxGeocoder({
				// Initialize the geocoder
				accessToken: mapboxgl.accessToken, // Set the access token
				mapboxgl: mapboxgl, // Set the mapbox-gl instance
				zoom: 13, // Set the zoom level for geocoding results
				placeholder: 'Enter an address or place name', // This placeholder text will display in the search bar
			});
			// Add the geocoder to the map
			mapApp.map.addControl(geocoder, 'top-left'); // Add the search box to the top left
		});

		function addRestaurants(restaurants) {
			// console.log(restaurants)
			const rest = restaurants.businesses;
			rest.forEach(rest => {
				const markerCard = `<div class="markerCard">
								<img src="${rest.image_url}">
								<a href='${rest.url}' target='_blank'>	
									<h4>${rest.name}</h4>
								</a>	
								<p>Rating: ${rest.rating}</p>
								<p>Price: ${rest.price}</p>
								<p>Category: ${rest.categories[0].title}</p>
								<p>Phone: ${rest.phone}</p>
								<a class='reviews' href='${rest.url}' target='_blank'>Reviews</a>
							</div>
							`

				const lat = rest.coordinates.latitude;
				const lon = rest.coordinates.longitude;
				
				new mapboxgl.Marker()
				.setLngLat([lon,lat])
				.setPopup(new mapboxgl.Popup().setHTML(markerCard))
				.addTo(mapApp.map);
			});
		}

		$('#userLocation').click(function(e) {
			e.preventDefault();
			$('#map').addClass('active');
			navigator.geolocation.getCurrentPosition( async position => {
				const lat = position.coords.latitude;
				const lon = position.coords.longitude;

				const api_url = `map/${lat},${lon}`;
				const response = await fetch(api_url);
				const json = await response.json();

				addRestaurants(json)
				
				await mapApp.map.flyTo({
					center: [lon,lat],
					zoom: 13
				});
			});
		});

		mapApp.map.on('moveend', async function(e) {
			const lat = mapApp.map.getCenter().lat;
			const lon = mapApp.map.getCenter().lng;

			const api_url = `map/${lat},${lon}`;
			const response = await fetch(api_url);
			const json = await response.json();

			addRestaurants(json)
		});
	</script>
</body>
</html>